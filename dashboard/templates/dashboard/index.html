{% load socialaccount %}
{% load bootstrap4 %}
{% load static %}
{% bootstrap_css %}
{% bootstrap_javascript jquery='full' %}

<html>
    <head>
        <link rel="stylesheet"
            href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-tagsinput/0.8.0/bootstrap-tagsinput.css"
            integrity="sha512-xmGTNt20S0t62wHLmQec2DauG9T+owP9e6VU8GigI0anN7OXLip9i7IwEhelasml2osdxX71XcYm6BQunTQeQg=="
            crossorigin="anonymous" />
        <link rel="stylesheet" href="https://cdn.datatables.net/1.10.24/css/dataTables.bootstrap4.min.css" crossorigin="anonymous">
    </head>
    <style type="text/css">
        .bootstrap-tagsinput {
            width: 100%;
        }
    
        .label-info {
            background-color: #17a2b8;
    
        }
    
        .label {
            display: inline-block;
            padding: .25em .4em;
            font-size: 75%;
            font-weight: 700;
            line-height: 1;
            text-align: center;
            white-space: nowrap;
            vertical-align: baseline;
            border-radius: .25rem;
            transition: color .15s ease-in-out, background-color .15s ease-in-out,
                border-color .15s ease-in-out, box-shadow .15s ease-in-out;
        }
        /*.our-taginput {
            
        }*/
        .primary {
            top: 20px;
            width: 75%;
        }
        /* .add-exercise {
            top: 10px;
            position: relative;
        } */
        hr {
            margin-top: 1rem;
            margin-bottom: 1rem;
            border: 0;
            border-top: 1px solid rgba(0, 0, 0, 0.1);
        }
        .btn-journal {
            margin-top: -6;
            margin-bottom: -5;
            margin-right: -5px;
            float: right;
        }

    </style>
        <script>

            function getCookie(name) {
                let cookieValue = null;
                if (document.cookie && document.cookie !== '') {
                    const cookies = document.cookie.split(';');
                    for (let i = 0; i < cookies.length; i++) {
                        const cookie = cookies[i].trim();
                        if (cookie.substring(0, name.length + 1) === (name + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            }

            const csrftoken = getCookie('csrftoken');

            $.ajaxSetup({
                beforeSend: function (xhr, settings) {
                    if (settings.type == "POST" && !this.crossDomain) {
                        xhr.setRequestHeader("X-CSRFToken", csrftoken);
                    }
                }
            });

            var journalOpen = false;
            var unsavedChanges = false;
            var currentJournal = -1;

            function showJournal() {
                $('#journal').show();
                $('#journal-save').show();
                $('#journal-cancel').show();
                $.ajax({
                    type: 'post',
                    url: 'get_exercise',
                    data: {
                        id: currentJournal
                    },
                    success: function(msg) {
                        $("#journal").val(msg.journal);
                    },
                    error: function(a, b, c) {
                        console.log([a,b,c]);
                    }
                });
                journalOpen = true;
            }

            function hideJournal() {
                $('#journal').hide();
                $('#journal-save').hide();
                $('#journal-cancel').hide();
                journalOpen = false;
            }

            function openJournal(id) {
                if(journalOpen) return;
                unsavedChanges = false;
                currentJournal = id;
                showJournal();
            }

            function submitJournal() {
                if(!journalOpen) return;
                $.ajax({
                    type: 'post',
                    url: 'set_journal',
                    data: {
                        id: currentJournal,
                        journal_contents: $('#journal').val()
                    },
                    success: function(msg) {
                        unsavedChanges = false;
                        $('#save-badge').show();
                        setTimeout(function() {
                            $('#save-badge').hide();
                        }, 1200);
                    },
                    error: function(a, b, c) {
                        console.log([a,b,c]);
                    }
                });
            }

            function cancelJournal() {
                if(!journalOpen) return;
                if(unsavedChanges) {
                    $('#saveDialogue').modal('show');
                } else {
                    closeJournal();
                }
            }

            function closeJournal() {
                $('#journal').val("");
                currentJournal = -1;
                hideJournal();
            }

            $(document).ready(function () {
                hideJournal();
                $('#save-badge').hide();    
                var table = $('#etable').DataTable();
                $('#navbar-inner').width($('#main-card').width());
            });

        </script>
<body>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-tagsinput/0.8.0/bootstrap-tagsinput.js"
        integrity="sha512-VvWznBcyBJK71YKEKDMpZ0pCVxjNuKwApp4zLF3ul+CiflQi6aIJR+aZCP/qWsoFBA28avL5T5HA+RE+zrGQYg=="
        crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-tagsinput/0.8.0/bootstrap-tagsinput-angular.min.js"
        integrity="sha512-KT0oYlhnDf0XQfjuCS/QIw4sjTHdkefv8rOJY5HHdNEZ6AmOh1DW/ZdSqpipe+2AEXym5D0khNu95Mtmw9VNKg=="
        crossorigin="anonymous"></script>
    <script src="https://cdn.datatables.net/1.10.24/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.10.24/js/dataTables.bootstrap4.min.js"></script>

    <nav class="navbar navbar-expand-lg navbar-light bg-light">
        <div class="mx-auto" id="navbar-inner" style="padding: 0; margin: 0;">
            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav"
                aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav mr-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/home">Home <span class="sr-only">(current)</span></a>
                    </li>
                    <li class="nav-item active">
                        <a class="nav-link" href="/dashboard">Exercise Dashboard <span class="sr-only">(current)</span></a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/leaderboard">Leaderboard</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/music">Music</a>
                    </li>
                </ul>
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link mr-2 " href="/profile/friends/">Friends</a>
                    </li>
                    <li class="nav-item" style="margin-right:8px;">
                        <a href="/profile" class="navbar-text">Profile</a>
                    </li>
                </ul>        
            </div>
        </div>
    </nav>
    <div class="modal fade" id="saveDialogue" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle"
        aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLongTitle">You have unsaved changes</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                    <button onclick="closeJournal()" type="button" class="btn btn-danger" data-dismiss="modal">Discard changes</button>
                </div>
            </div>
        </div>
    </div>
    <div class="container">
        <div class="card primary mx-auto" id="main-card">
            <div class="card-body">
                <table class="table table-striped table-bordered" id="etable" style="width:100%">
                    <thead>
                      <tr>
                        <th scope="col">Type</th>
                        <th scope="col">Name</th>
                        <th scope="col">Body Parts Worked</th>
                      </tr>
                    </thead>
                    <tbody>
                        {% for exercise in user_exercises %}
                            <tr>
                                <td>{{exercise.type}}</td>
                                <td>{{exercise.name}}</td>
                                <td>
                                    {{exercise.parts_worked|join:', '}}
                                    <button onclick="openJournal( {{ exercise.id }} )" class="btn btn-secondary  btn-sm btn-journal">Add Notes</button>
                                </td>
                            </tr>    
                        {% endfor %}
                    </tbody>
                  </table>
                <div class="add-exercise">
                    <textarea class="form-control" id="journal" onchange="unsavedChanges=true" style="margin-top: 6px; margin-bottom: 8px"></textarea>
                    <button id="journal-save" onclick="submitJournal()" type="button" class="btn btn-success">Save</button>
                    <button id="journal-cancel" onclick="cancelJournal()" type="button" class="btn btn-secondary">Close</button>
                    <span id="save-badge" class="badge badge-success">Saved</span>
                    <hr />
                    <h3>Add exercise</h3>
                    <form action="submit_exercise" method="post">
                        {% csrf_token %}
                        <div class="row">
                            <div class="col-auto">
                                <h6>Type</h6>
                                <input type="text" class="form-control form-control-sm" placeholder="Resistance" name="type">
                            </div>
                            <div class="col-auto">
                                <h6>Name</h6>
                                <input type="text" class="form-control form-control-sm" placeholder="Plank" name="name">
                            </div>
                            <div class="col">
                                <h6>Body Parts Worked</h6>
                                <input class="form-control" type="text" data-role="tagsinput" name="tags" value="Core">
                            </div>
                            <div class="col-auto">
                                <h6><br></h6>
                                <button type="submit" class="btn btn-primary btn-sm">Add</button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</body>

</html>